version: 2
jobs:
  build:
    docker:
      - image: circleci/node:7.10
    working_directory: ~/repo

    steps:
      - checkout
      - restore_cache:
          keys:
          - v1-dependencies-{{ checksum "package.json" }}
          - v1-dependencies-
      - run: yarn install
      - save_cache:
          paths:
            - node_modules
          key: v1-dependencies-{{ checksum "package.json" }}
      - run: yarn test

  upload:
    environment:
      GCLOUD_SERVICE_KEY: ewogICJ0eXBlIjogInNlcnZpY2VfYWNjb3VudCIsCiAgInByb2plY3RfaWQiOiAicG9ydGZvbGlv LTIwMzkxMiIsCiAgInByaXZhdGVfa2V5X2lkIjogImEzZmVlNzkyZGI5NTM1NTYzODgwNWRhZjFm NzczYWQ5ZDNkYTBmYzUiLAogICJwcml2YXRlX2tleSI6ICItLS0tLUJFR0lOIFBSSVZBVEUgS0VZ LS0tLS1cbk1JSUV2QUlCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQktZd2dnU2lBZ0VBQW9JQkFR RGRDK0w1bDVVMG9YdURcbkI2WkorclBoQmQ5V0ovMkZkQnBneHBVdDVZelBaVGN5M0IrVlQ4aU9t dENvWEdkSWNRWDJYTFVtWnY4OGNnd2hcbnhQb1UrYWVxbWdQaFRRVVNWc3YxZmpuSy9zYnJsWVpS b0ZGMkNwdm9ZV2REUy9TMGU4YXJhSW9GWTRuWm0wY2xcbkhpcjB6VGVZYlFJUTdwb3dIT00yUjk0 MC9NVTZUeUpIZUEyOWx1NnJrb1Q2aWlJSUJHZEZuWG5aU0VJKzZESGNcbkRSSnVid3FsWXdvRStN dVE5QSthelMvdms4ZXp3NmhCR290a2RKRmR5Rk1PMjJKTXRRQnkxZk1zY0kvSGxrZ1pcbmlBbFYy WDBPTGovY0lKWHhlbXZxcHd5T0FwNWNWVmoyOE5nd0o1bkVuZTV0bmlpSVc1VENzOTUwd2ozUmJ0 OVhcbjZLV0t2dUxMQWdNQkFBRUNnZ0VBVThxc3VLWndaZW9NMHVlMGJuaTlkVUJ2bjg0NitUckF3 UXltQWlieEVMRXlcbmtuSUUrdW1xZ2Z4SHVucUVvRjVQdjByM1ZGNVl4SVlLK1VZYzhwU01yVXdD eW9ZU3RSZjM2dEIxZ2ZEQVlROW1cblFreitkRHVqVEJ5WU0xZDRwRzRES25qUFVTbWhXTDdXNGtn a1NuWDhiQ2h1VHhMVG1nZHBUZXRDWFYyd09lQ09cbi9LM2pYSlN2YSsyVzlIZERWMjZTVDFUK1pl a3Z1dGZsbFZyUlpIemEyREtpU1VpTkZpQy9XMTgzencwOWV0Ty9cblVwRkU0b2twY1JWQWRGc3Jj Ry83cVB0ajNWVkM5czVGbVdLTE1jaHFIZGhaMndkbnpkaFNUYmp6LzVjTlg0ZmJcbkJwQXpSK2Z2 bWFMeEVpY3RQTlVYZmVxUEJEQkgrQTR1MG1XNkxuSGxNUUtCZ1FENGxxYXhaRS9wZkorejVQdkdc bmFadkJDOTZzZExzM1dOZ3lrTTBKem9kN3hxZEIvazdpUzUvREY1THZoY1kxck5jMDNaRjU4VHZX VloyeHJNSWNcbjlsYkhVN3hKM1JJd1k1Y0RnT1FyRktVU1J5MDFhKzVkcEo5T1lMUi9xSXJQUUtP SzR2bjhEVlBXOGVkVGRBSVpcbjN1Q0gzOXFxUDJXVjZhZnYxaTQvbGxnS0NRS0JnUURqb3dWbUxM TGhNV2xGUjVLcTBFdDRFbDR0aENEOXRWWFpcbk55YmNwQlh2cVdReVZJOElYNjRldk9NRk5iNDdS VjRzQ1NXTkJyWmxsU3RJekRDS2Z4RThVUGw3T0V1SzkvTWxcbk8zUC9MMm1jYnQrUysydWp0c2Jh MDJCUENyZ1IwSnl2VmE5NGI5VURVeUFENnRIZFRXZVhlV0VTZ1J2YnRDWWZcbkdTWjFOREtMTXdL QmdCV1pFVGFNWHAwTXBOdCtZNW1qaDFMSWN6cE1rZytHK3BHNkh2WmhLVWhKeERKcG8vVHBcbldT SWNKRG9IUjJkV2N3UTIwL0xpVUs2WWxiRGdMNlZRaWMyYnF0cElDTktIZEpGclcyZWF6WlMrOW1D VDFndndcbng1NkpyR1VEQWJ4c0EwbUgydXhaUkJXQ3d2UnZPZGVCazhSNllJYzJKdDlWZzYvRXpo UGNQaDN4QW9HQVdOdFRcbnlqUjhodWJ3dnJoWGloSFF3OGYzdHpDeWFCYVdzam1URStHQkpwSXFx SExWZW1GTzZIUzI4VnV2TEJmQjBOS3Bcbk04bUEvVm9qRVVHVFdSeU1yOHl6OWVOZHFadHI4QWFy R3R0NUVEVS9WSEtMNjlYMi9ZZ3hPZWxuUEp6LzdIazRcbkMzMHIyeVpoZ3VYd2tjQWJSY2Q5bXVt RzVGWUg0MisvMFZSVXZuMENnWUJPeDBCWFFLMnYvUUlER2QrR3A2eGVcblVSMlZXVVBYdUo0dzha cHN4Z1o5bUhiUUdERkdZUGpzSFpxOTVSQ3VvSmlFOEpvY05NYTFIYnR3eWZWV2F4bEdcbnBIWWRM SWlDWXQyY0J0YVJRenJVbldmcnhybitXcEp0c25OM1FxdDk0VTVXLzRXWHhKSE9EWlBGTlpHazRX K2NcbjRwSEc5bjZrcEcxaVc4azd2RlZjaXc9PVxuLS0tLS1FTkQgUFJJVkFURSBLRVktLS0tLVxu IiwKICAiY2xpZW50X2VtYWlsIjogImNpcmNsZS1jaUBwb3J0Zm9saW8tMjAzOTEyLmlhbS5nc2Vy dmljZWFjY291bnQuY29tIiwKICAiY2xpZW50X2lkIjogIjExNjU3ODEwODQxNjY2OTAyNjQ1MiIs CiAgImF1dGhfdXJpIjogImh0dHBzOi8vYWNjb3VudHMuZ29vZ2xlLmNvbS9vL29hdXRoMi9hdXRo IiwKICAidG9rZW5fdXJpIjogImh0dHBzOi8vb2F1dGgyLmdvb2dsZWFwaXMuY29tL3Rva2VuIiwK ICAiYXV0aF9wcm92aWRlcl94NTA5X2NlcnRfdXJsIjogImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMu Y29tL29hdXRoMi92MS9jZXJ0cyIsCiAgImNsaWVudF94NTA5X2NlcnRfdXJsIjogImh0dHBzOi8v d3d3Lmdvb2dsZWFwaXMuY29tL3JvYm90L3YxL21ldGFkYXRhL3g1MDkvY2lyY2xlLWNpJTQwcG9y dGZvbGlvLTIwMzkxMi5pYW0uZ3NlcnZpY2VhY2NvdW50LmNvbSIKfQo=
    docker:
      - image: gcr.io/portfolio-203912/circleci-gcloud
        auth:
          username: _json_key
          password:  echo $GCLOUD_SERVICE_KEY | base64 -d 
    steps:
      - checkout
      - run:
          name: Upload to Cloud
          command: cd deploy && python3 upload.py
  deploy:
    docker:
    - image: gcr.io/portfolio-203912/circleci-gcloud
      auth:
        username: _json_key
        password: echo $GCLOUD_SERVICE_KEY | base64 -d
    steps:
      - checkout 
      - run:
          name: Deploy to Google
          command: cd deploy && python3 deploy.py

workflows:
  version: 2
  build-deploy:
    jobs:
      - build
      - upload:
          requires:
            - build
          filters:
            branches:
              only: master
      - deploy:
          requires:
            - upload
          filters:
            branches:
              only: master