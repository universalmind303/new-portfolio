version: 2
jobs:
  build:
    docker:
      - image: circleci/node:7.10
    working_directory: ~/repo

    steps:
      - checkout
      - restore_cache:
          keys:
          - v1-dependencies-{{ checksum "package.json" }}
          - v1-dependencies-
      - run: yarn install
      - save_cache:
          paths:
            - node_modules
          key: v1-dependencies-{{ checksum "package.json" }}
      - run: yarn test

  upload:
    environment:
      GCLOUD_SERVICE_KEY: '{ "type": "service_account", "project_id": "portfolio-203912", "private_key_id": "a3fee792db95355638805daf1f773ad9d3da0fc5", "private_key": "-----BEGIN PRIVATE KEY-----\nMIIEvAIBADANBgkqhkiG9w0BAQEFAASCBKYwggSiAgEAAoIBAQDdC+L5l5U0oXuD\nB6ZJ+rPhBd9WJ/2FdBpgxpUt5YzPZTcy3B+VT8iOmtCoXGdIcQX2XLUmZv88cgwh\nxPoU+aeqmgPhTQUSVsv1fjnK/sbrlYZRoFF2CpvoYWdDS/S0e8araIoFY4nZm0cl\nHir0zTeYbQIQ7powHOM2R940/MU6TyJHeA29lu6rkoT6iiIIBGdFnXnZSEI+6DHc\nDRJubwqlYwoE+MuQ9A+azS/vk8ezw6hBGotkdJFdyFMO22JMtQBy1fMscI/HlkgZ\niAlV2X0OLj/cIJXxemvqpwyOAp5cVVj28NgwJ5nEne5tniiIW5TCs950wj3Rbt9X\n6KWKvuLLAgMBAAECggEAU8qsuKZwZeoM0ue0bni9dUBvn846+TrAwQymAibxELEy\nknIE+umqgfxHunqEoF5Pv0r3VF5YxIYK+UYc8pSMrUwCyoYStRf36tB1gfDAYQ9m\nQkz+dDujTByYM1d4pG4DKnjPUSmhWL7W4kgkSnX8bChuTxLTmgdpTetCXV2wOeCO\n/K3jXJSva+2W9HdDV26ST1T+ZekvutfllVrRZHza2DKiSUiNFiC/W183zw09etO/\nUpFE4okpcRVAdFsrcG/7qPtj3VVC9s5FmWKLMchqHdhZ2wdnzdhSTbjz/5cNX4fb\nBpAzR+fvmaLxEictPNUXfeqPBDBH+A4u0mW6LnHlMQKBgQD4lqaxZE/pfJ+z5PvG\naZvBC96sdLs3WNgykM0Jzod7xqdB/k7iS5/DF5LvhcY1rNc03ZF58TvWVZ2xrMIc\n9lbHU7xJ3RIwY5cDgOQrFKUSRy01a+5dpJ9OYLR/qIrPQKOK4vn8DVPW8edTdAIZ\n3uCH39qqP2WV6afv1i4/llgKCQKBgQDjowVmLLLhMWlFR5Kq0Et4El4thCD9tVXZ\nNybcpBXvqWQyVI8IX64evOMFNb47RV4sCSWNBrZllStIzDCKfxE8UPl7OEuK9/Ml\nO3P/L2mcbt+S+2ujtsba02BPCrgR0JyvVa94b9UDUyAD6tHdTWeXeWESgRvbtCYf\nGSZ1NDKLMwKBgBWZETaMXp0MpNt+Y5mjh1LIczpMkg+G+pG6HvZhKUhJxDJpo/Tp\nWSIcJDoHR2dWcwQ20/LiUK6YlbDgL6VQic2bqtpICNKHdJFrW2eazZS+9mCT1gvw\nx56JrGUDAbxsA0mH2uxZRBWCwvRvOdeBk8R6YIc2Jt9Vg6/EzhPcPh3xAoGAWNtT\nyjR8hubwvrhXihHQw8f3tzCyaBaWsjmTE+GBJpIqqHLVemFO6HS28VuvLBfB0NKp\nM8mA/VojEUGTWRyMr8yz9eNdqZtr8AarGtt5EDU/VHKL69X2/YgxOelnPJz/7Hk4\nC30r2yZhguXwkcAbRcd9mumG5FYH42+/0VRUvn0CgYBOx0BXQK2v/QIDGd+Gp6xe\nUR2VWUPXuJ4w8ZpsxgZ9mHbQGDFGYPjsHZq95RCuoJiE8JocNMa1HbtwyfVWaxlG\npHYdLIiCYt2cBtaRQzrUnWfrxrn+WpJtsnN3Qqt94U5W/4WXxJHODZPFNZGk4W+c\n4pHG9n6kpG1iW8k7vFVciw==\n-----END PRIVATE KEY-----\n", "client_email": "circle-ci@portfolio-203912.iam.gserviceaccount.com", "client_id": "116578108416669026452", "auth_uri": "https://accounts.google.com/o/oauth2/auth", "token_uri": "https://oauth2.googleapis.com/token", "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs", "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/circle-ci%40portfolio-203912.iam.gserviceaccount.com" }'
    docker:
      - image: gcr.io/portfolio-203912/circleci-gcloud
        auth:
          username: _json_key
          password: $GCLOUD_SERVICE_KEY
    steps:
      - checkout
      - run:
          name: Upload to Cloud
          command: cd deploy && python3 upload.py
  deploy:
    docker:
    - image: gcr.io/portfolio-203912/circleci-gcloud
      auth:
        username: _json_key
        password: $GCLOUD_SERVICE_KEY
    steps:
      - checkout 
      - run:
          name: Deploy to Google
          command: cd deploy && python3 deploy.py

workflows:
  version: 2
  build--upload-deploy:
    jobs:
      - build
      - upload:
          requires:
            - build
          filters:
            branches:
              only: master
      - deploy:
          requires:
            - upload
          filters:
            branches:
              only: master